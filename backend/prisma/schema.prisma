// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  profilePhoto String?
  birthday     DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  createdWorkouts   Workout[]               @relation("WorkoutCreator") // Workouts they created (admin)
  workoutPlans      WorkoutPlan[]          // Their personal workout plans
  workoutLogs       WorkoutLog[]           // Their personal workout logs
  personalRecords   WorkoutPersonalRecord[]
  planTemplates     WorkoutPlanTemplate[]   @relation("PlanTemplateCreator")

  @@map("users")
}

model Workout {
  id          String   @id @default(cuid())
  title       String
  category    String   // Predefined categories: "Upper Body - Pull", "Upper Body - Push", "Legs", "Core", "Climbing - Power", "Climbing - Endurance", "Climbing - Warm Up", "Cardio"
  description String?
  workoutType String   // "strength" or "cardio"
  sets        Int?     // Only for strength workouts
  reps        Int?     // Only for strength workouts
  duration    Int?     // Only for cardio workouts (in minutes)
  intensity   String   // e.g., "weight", "RPE", "bodyweight", "pace", "heart rate"
  imageUrl    String?
  imageUrl2   String?  @map("imageUrl2")
  isGlobal    Boolean  @default(true) // Global workout library - shared across all users
  createdBy   String?  // Optional: who created this workout (for admin purposes)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  creator         User?                   @relation("WorkoutCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  planItems       PlanItem[]
  workoutLogs     WorkoutLog[]
  personalRecords WorkoutPersonalRecord[]

  @@map("workouts")
}

model WorkoutPlan {
  id          String   @id @default(cuid())
  name        String
  startDate   DateTime
  endDate     DateTime
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  planItems PlanItem[]

  @@map("workout_plans")
}

model PlanItem {
  id           String   @id @default(cuid())
  workoutId    String
  workoutPlanId String
  // each PlanItem represents a single dated occurrence after consolidation
  intensity   String?  // override intensity for this plan item
  scheduledDate DateTime @map("scheduled_date")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workout     Workout     @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutPlan WorkoutPlan @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)
  // no separate plan item dates; each PlanItem is dated

  @@map("plan_items")
}

model WorkoutLog {
  id        String   @id @default(cuid())
  workoutId String
  userId    String
  date      DateTime
  sets      Int?     // Only for strength workouts
  reps      Int?     // Only for strength workouts
  duration  Int?     // Only for cardio workouts (in minutes)
  weight    Float?   // For strength workouts
  rpe       Int?     // Rate of Perceived Exertion (1-10)
  pace      String?  // For cardio workouts (e.g., "8:30/mile")
  heartRate Int?     // For cardio workouts (BPM)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("workout_logs")
}

model WorkoutPersonalRecord {
  id        String   @id @default(cuid())
  userId    String
  workoutId String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@unique([userId, workoutId])
  @@map("workout_personal_records")
}

model WorkoutImport {
  id             String   @id @default(uuid())
  userId         String
  sourceUrl      String
  sourcePlatform String?
  title          String?
  category       String?
  description    String?
  thumbnailUrl   String?
  html           String?
  metadata       Json?
  isGlobal       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sourcePlatform])
  @@map("workout_imports")
}

model WorkoutPlanTemplate {
  id               String   @id @default(cuid())
  name             String
  description      String?
  numWeeks         Int
  daysPerWeek      Int
  workoutStructure Json
  level            String?
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  creator User? @relation("PlanTemplateCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@map("workout_plan_templates")
}
